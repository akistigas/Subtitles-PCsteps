<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Μεταφραστής Υποτίτλων SRT με Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone.dragover {
            background-color: #e2e8f0;
            border-color: #94a3b8;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Make password reveal icon visible */
        input[type="password"]::-ms-reveal,
        input[type="password"]::-ms-clear {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-6">
            <h2 class="text-4xl font-bold text-slate-800 tracking-wider">PC<span class="text-blue-600">steps</span></h2>
        </div>
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-slate-900">Μεταφραστής Υποτίτλων SRT</h1>
            <p class="text-slate-500 mt-2">Μεταφράστε αρχεία `.srt` στα Ελληνικά με τη δύναμη του Gemini.</p>
        </div>

        <!-- File Upload Area -->
        <div id="upload-container">
            <div id="drop-zone" class="drop-zone rounded-lg p-8 text-center cursor-pointer hover:bg-slate-100">
                <input type="file" id="file-input" class="hidden" accept=".srt">
                <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-4 text-slate-600">Σύρετε & αποθέστε το αρχείο `.srt` εδώ</p>
                <p class="text-sm text-slate-500">ή</p>
                <button id="browse-btn" type="button" class="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-700">Επιλέξτε αρχείο</button>
            </div>
            <p id="file-name" class="text-center text-sm text-slate-500 mt-4"></p>
        </div>
        
        <!-- API Key Input -->
        <div class="mt-6">
            <label for="api-key-input" class="block text-sm font-medium text-slate-700">Gemini API Key</label>
            <div class="relative mt-1">
                <input type="password" id="api-key-input" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Εισάγετε το API key σας εδώ">
                 <button id="toggle-visibility" type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-sm text-slate-500 hover:text-slate-700">
                    <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                      <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.816 1.097-2.084 2.22-3.64 2.893C9.879 11.832 8.12 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                      <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                    </svg>
                    <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash hidden" viewBox="0 0 16 16">
                      <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.94 5.94 0 0 1 8 5.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/>
                      <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.288.822.822.084.083a3.5 3.5 0 0 1-4.474-4.474l.823.823.084.083a2.5 2.5 0 0 0 2.829 2.829z"/>
                      <path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 6.564l-12-12 .708-.708 12 12-.708.708z"/>
                    </svg>
                 </button>
            </div>
            <p class="mt-2 text-xs text-slate-500">Το API key σας αποθηκεύεται μόνο στον περιηγητή σας. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Αποκτήστε ένα δωρεάν κλειδί εδώ.</a></p>
        </div>

        <!-- Action Button -->
        <div class="mt-6 text-center">
            <button id="translate-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors shadow-md" disabled>
                Μετάφραση
            </button>
        </div>

        <!-- Status & Result Area -->
        <div id="status-container" class="mt-6 text-center hidden">
            <div id="loader" class="loader mx-auto hidden"></div>
            <p id="status-text" class="text-slate-600 mt-4"></p>
            <div id="result-container" class="mt-4 hidden">
                 <button id="download-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                    Λήψη Μεταφρασμένου Αρχείου
                </button>
            </div>
             <p id="error-message" class="text-red-500 mt-4 font-medium hidden"></p>
        </div>

    </div>

    <script>
        // DOM Element References
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const fileNameDisplay = document.getElementById('file-name');
        const apiKeyInput = document.getElementById('api-key-input');
        const translateBtn = document.getElementById('translate-btn');
        const statusContainer = document.getElementById('status-container');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');
        const resultContainer = document.getElementById('result-container');
        const downloadBtn = document.getElementById('download-btn');
        const errorMessage = document.getElementById('error-message');
        const toggleVisibilityBtn = document.getElementById('toggle-visibility');
        const eyeOpen = document.getElementById('eye-open');
        const eyeClosed = document.getElementById('eye-closed');

        let uploadedFile = null;
        let originalFileName = '';
        let translatedSrtContent = '';

        // --- UI Logic ---
        
        const updateTranslateButtonState = () => {
            translateBtn.disabled = !(uploadedFile && apiKeyInput.value.trim());
        };

        toggleVisibilityBtn.addEventListener('click', () => {
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            eyeOpen.classList.toggle('hidden', isPassword);
            eyeClosed.classList.toggle('hidden', !isPassword);
        });

        // --- File Handling Logic ---

        const handleFileSelect = (file) => {
            if (file && file.name.toLowerCase().endsWith('.srt')) {
                uploadedFile = file;
                originalFileName = file.name;
                fileNameDisplay.textContent = `Επιλεγμένο αρχείο: ${file.name}`;
                errorMessage.classList.add('hidden');
            } else {
                showError('Παρακαλώ επιλέξτε ένα έγκυρο αρχείο .srt');
                resetState();
            }
            updateTranslateButtonState();
        };

        dropZone.addEventListener('click', () => fileInput.click());
        
        browseBtn.addEventListener('click', (e) => {
            // Αποτρέπει το "κλικ" να φτάσει και στο γονικό στοιχείο (drop-zone), λύνοντας το πρόβλημα του διπλού κλικ.
            e.stopPropagation(); 
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
        apiKeyInput.addEventListener('input', updateTranslateButtonState);

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFileSelect(e.dataTransfer.files[0]);
        });
        
        // --- Core Translation Logic ---

        translateBtn.addEventListener('click', async () => {
            if (!uploadedFile || !apiKeyInput.value.trim()) return;

            resetResultState();
            statusContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            translateBtn.disabled = true;
            
            try {
                statusText.textContent = 'Ανάγνωση αρχείου...';
                const fileContent = await uploadedFile.text();

                statusText.textContent = 'Ανάλυση υποτίτλων (parsing)...';
                const subtitles = parseSrt(fileContent);
                if (subtitles.length === 0) throw new Error('Δεν βρέθηκαν υπότιτλοι ή το αρχείο δεν είναι σε έγκυρη μορφή SRT.');
                
                statusText.textContent = 'Μετάφραση υποτίτλων (αυτό μπορεί να διαρκέσει λίγο)...';
                const translatedTexts = await translateInParallel(subtitles, apiKeyInput.value.trim());

                statusText.textContent = 'Ανασύνθεση αρχείου...';
                translatedSrtContent = reconstructSrt(subtitles, translatedTexts);

                statusText.textContent = 'Η μετάφραση ολοκληρώθηκε!';
                loader.classList.add('hidden');
                resultContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Translation Error:', error);
                showError(error.message || 'Προέκυψε ένα σφάλμα κατά τη μετάφραση.');
                loader.classList.add('hidden');
            } finally {
                updateTranslateButtonState();
            }
        });

        /**
         * Translates subtitles by sending multiple chunks to the API concurrently.
         */
        async function translateInParallel(subtitles, apiKey) {
            const chunkSize = 150; // Number of subtitles per API call
            const delimiter = '|||---|||';
            const chunks = [];

            for (let i = 0; i < subtitles.length; i += chunkSize) {
                const subtitleChunk = subtitles.slice(i, i + chunkSize);
                chunks.push(subtitleChunk.map(s => s.text).join(delimiter));
            }

            const promises = chunks.map(chunkText => translateTextWithGemini(chunkText, delimiter, apiKey));
            const results = await Promise.all(promises);

            // Flatten the array of arrays into a single array of translated texts
            return results.flat();
        }

        // --- SRT Parsing and Reconstruction ---

        function parseSrt(srtContent) {
            const pattern = /(\d+)\s*(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})\s*([\s\S]*?(?=\n\n|\n*$))/g;
            const subtitles = [];
            let match;
            while ((match = pattern.exec(srtContent)) !== null) {
                subtitles.push({
                    index: match[1],
                    time: `${match[2]} --> ${match[3]}`,
                    text: match[4].trim().replace(/\r?\n/g, ' ')
                });
            }
            return subtitles;
        }

        function reconstructSrt(originalSubtitles, translatedTexts) {
            if (originalSubtitles.length !== translatedTexts.length) {
                console.warn('Mismatch in subtitle count:', originalSubtitles.length, translatedTexts.length);
            }
            return originalSubtitles
                .map((sub, index) => {
                    const translatedText = translatedTexts[index] || sub.text;
                    return `${sub.index}\n${sub.time}\n${translatedText}`;
                })
                .join('\n\n');
        }

        // --- Gemini API Call ---
        
        async function translateTextWithGemini(text, delimiter, apiKey) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `Translate each of the following text segments to Modern Greek. Maintain the meaning and context accurately. The segments are separated by "${delimiter}". Return only the translated segments, separated by the same "${delimiter}". Do not add any extra text, explanations, or formatting.\n\n${text}`;
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const responseText = await response.text();

            if (!response.ok) {
                let errorMessage = `Σφάλμα από το Gemini API: ${response.status} ${response.statusText}`;
                try {
                    const errorBody = JSON.parse(responseText);
                    errorMessage = `Σφάλμα από το Gemini API: ${errorBody.error?.message || response.statusText}`;
                } catch (e) {
                    if (responseText) errorMessage += ` - ${responseText}`;
                }
                console.error("API Error Response Text:", responseText);
                throw new Error(errorMessage);
            }

            const result = JSON.parse(responseText);
            
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                const translatedBatch = result.candidates[0].content.parts[0].text;
                return translatedBatch.split(delimiter).map(t => t.trim());
            } else {
                console.error("Unexpected API response structure:", result);
                throw new Error('Η απάντηση από το Gemini API δεν είχε την αναμενόμενη δομή.');
            }
        }

        // --- Download and UI Helper Functions ---

        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([translatedSrtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const newFileName = originalFileName.replace(/\.srt$/i, '.el.srt');
            a.download = newFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function resetState() {
            uploadedFile = null;
            originalFileName = '';
            fileNameDisplay.textContent = '';
            updateTranslateButtonState();
        }

        function resetResultState() {
            statusContainer.classList.add('hidden');
            resultContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            statusText.textContent = '';
            translatedSrtContent = '';
        }
    </script>
</body>
</html>
