translateBtn.addEventListener('click', async () => {
    if (!selectedFile) {
        showMessage("error", "Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ .srt.");
        return;
    }
    loadingSpinner.classList.remove('hidden');
    translateBtn.disabled = true;
    messageBox.style.display = 'none';
    downloadLink.style.display = 'none';
    let translationErrorOccurred = false;

    try {
        const fileContent = await selectedFile.text();
        const srtBlocks = parseSrt(fileContent);
        if (srtBlocks.length === 0) {
            showMessage("info", "Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ SRT ÎµÎ¯Î½Î±Î¹ ÎºÎµÎ½ÏŒ Î® Î­Ï‡ÎµÎ¹ Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½Î· Î¼Î¿ÏÏ†Î®.");
            return;
        }

        const translatedBlocks = new Array(srtBlocks.length);
        let batches = [];
        let currentBatchTexts = [];
        let currentBatchOriginalIndices = [];

        // Create batches
        for (let i = 0; i < srtBlocks.length; i++) {
            const block = srtBlocks[i];
            const blockText = block.text;
            const potentialBatchSize = currentBatchTexts.join(DELIMITER).length + blockText.length + (currentBatchTexts.length > 0 ? DELIMITER.length : 0);

            if (potentialBatchSize > MAX_CHARS_PER_BATCH && currentBatchTexts.length > 0) {
                batches.push({
                    texts: currentBatchTexts,
                    originalIndices: currentBatchOriginalIndices
                });
                currentBatchTexts = [];
                currentBatchOriginalIndices = [];
            }
            currentBatchTexts.push(blockText);
            currentBatchOriginalIndices.push(i);

            if (i === srtBlocks.length - 1 && currentBatchTexts.length > 0) {
                batches.push({
                    texts: currentBatchTexts,
                    originalIndices: currentBatchOriginalIndices
                });
            }
        }

        // Process each batch
        for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
            const batch = batches[batchIndex];
            const batchPromptText = batch.texts.join(DELIMITER);

            const translationPrompt = `ÎœÎµÏ„Î¬Ï†ÏÎ±ÏƒÎµ Ï„Î± Î±ÎºÏŒÎ»Î¿Ï…Î¸Î± Ï„Î¼Î®Î¼Î±Ï„Î± Ï…Ï€Î¿Ï„Î¯Ï„Î»Ï‰Î½ Î±Ï€ÏŒ Ï„Î± Î‘Î³Î³Î»Î¹ÎºÎ¬ ÏƒÏ„Î± Î•Î»Î»Î·Î½Î¹ÎºÎ¬. ÎšÎ¬Î¸Îµ Ï„Î¼Î®Î¼Î± Î¿ÏÎ¹Î¿Î¸ÎµÏ„ÎµÎ¯Ï„Î±Î¹ Î‘ÎšÎ¡Î™Î’Î©Î£ Î±Ï€ÏŒ Ï„Î¿ \`${DELIMITER}\`. ÎœÎµÏ„Î¬Ï†ÏÎ±ÏƒÎµ Î¼ÏŒÎ½Î¿ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Î¼ÎµÏ„Î±Î¾Ï Ï„Ï‰Î½ Î¿ÏÎ¹Î¿Î¸ÎµÏ„Î·Ï„ÏÎ½, Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¼Î¯Î± Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ· (ÏŒÏ€Ï‰Ï‚ ÎµÏ„Î¹ÎºÎ­Ï„ÎµÏ‚ HTML), ÎºÎ±Î¹ Î´Î¹Î±Ï„Î®ÏÎ·ÏƒÎµ Ï„Î¿Î½ Î¯Î´Î¹Î¿ Î±ÏÎ¹Î¸Î¼ÏŒ Î¿ÏÎ¹Î¿Î¸ÎµÏ„Î·Ï„ÏÎ½ ÏƒÏ„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ® ÏƒÎ¿Ï…. ÎœÎ·Î½ Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„Î¿Ï…Ï‚ Î¿ÏÎ¹Î¿Î¸ÎµÏ„Î·Ï„Î­Ï‚ Î® Ï„Î· ÏƒÎµÎ¹ÏÎ¬ Ï„Ï‰Î½ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½. Î”Î¹Î±Ï„Î®Î½ÎµÎ¹ Ï„Î¿ Î±ÎºÏÎ¹Î²Î­Ï‚ Î½ÏŒÎ·Î¼Î± ÎºÎ±Î¹ ÏÏ†Î¿Ï‚ ÎºÎ¬Î¸Îµ Ï…Ï€Î¿Ï„Î¯Ï„Î»Î¿Ï…. Î•Î¬Î½ Î­Î½Î± Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ ÎºÎµÎ½ÏŒ, ÎµÏ€Î­ÏƒÏ„ÏÎµÏˆÎµ ÎºÎµÎ½ÏŒ Ï„Î¼Î®Î¼Î±.
\`\`\`
${batchPromptText}
\`\`\`
`;

            const firstIndex = batch.originalIndices[0] + 1;
            const lastIndex = batch.originalIndices[batch.originalIndices.length - 1] + 1;
            showMessage("info", `ÎœÎµÏ„Î±Ï†ÏÎ¬Î¶Î¿Î½Ï„Î±Î¹ Î¿Î¹ Ï…Ï€ÏŒÏ„Î¹Ï„Î»Î¿Î¹: ${firstIndex} - ${lastIndex} / ${srtBlocks.length} (Î¿Î¼Î±Î´Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î±, Î¿Î¼Î¬Î´Î± ${batchIndex + 1} Î±Ï€ÏŒ ${batches.length})`);

            try {
                const batchedTranslatedText = await callGeminiAPI(translationPrompt);

                // ğŸ”¥ ÎšÎ›Î•Î™Î”Î™ÎŸÎ¥ Î›Î¥Î£Î—: Î‘Î½Ï„Î¯ Î³Î¹Î± split(), Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½
                const delimiterRegex = new RegExp(`(${DELIMITER})`, 'g');
                const matches = [...batchedTranslatedText.matchAll(delimiterRegex)];
                
                // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï„Î¿ Ï€Î»Î®Î¸Î¿Ï‚ Ï„Ï‰Î½ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯
                if (matches.length !== batch.originalIndices.length) {
                    console.warn(`Î‘ÏƒÏ…Î¼Ï†Ï‰Î½Î¯Î± ÏƒÏ„Î¿ Ï€Î»Î®Î¸Î¿Ï‚ Ï„Ï‰Î½ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½. Î‘Î½Î±Î¼ÎµÎ½ÏŒÎ¼ÎµÎ½Î±: ${batch.originalIndices.length}, Î›Î®Ï†Î¸Î·ÎºÎ±Î½: ${matches.length}. Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÎµ Î±ÏÏ‡Î¹ÎºÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿.`);
                    translationErrorOccurred = true;

                    for (const originalIndex of batch.originalIndices) {
                        translatedBlocks[originalIndex] = {
                            id: srtBlocks[originalIndex].id,
                            timestamps: srtBlocks[originalIndex].timestamps,
                            text: srtBlocks[originalIndex].text + `
[Î‘Î´Ï…Î½Î±Î¼Î¯Î± Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·Ï‚ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚ - Î‘ÏƒÏ…Î¼Ï†Ï‰Î½Î¯Î± Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½]`
                        };
                    }
                } else {
                    // Î•Î¾Î±Î³Ï‰Î³Î® Ï„Ï‰Î½ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ Î¼ÎµÏ„Î±Î¾Ï Ï„Ï‰Î½ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½
                    let start = 0;
                    const extractedSegments = [];

                    for (let i = 0; i < matches.length; i++) {
                        const match = matches[i];
                        const segmentStart = start;
                        const segmentEnd = match.index;

                        const segment = batchedTranslatedText.substring(segmentStart, segmentEnd).trim();
                        extractedSegments.push(stripHtmlTags(segment));

                        start = match.index + match[0].length; // ÎÎµÎºÎ¹Î½Î¬Î¼Îµ Î¼ÎµÏ„Î¬ Ï„Î¿ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏŒ
                    }

                    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï„Î¿Ï… Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï… Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚ (Î¼ÎµÏ„Î¬ Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏŒ)
                    const finalSegment = batchedTranslatedText.substring(start).trim();
                    extractedSegments.push(stripHtmlTags(finalSegment));

                    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï„Î¿ Ï€Î»Î®Î¸Î¿Ï‚ Ï„Ï‰Î½ ÎµÎ¾Î±Ï‡Î¸Î­Î½Ï„Ï‰Î½ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯
                    if (extractedSegments.length !== batch.originalIndices.length) {
                        console.warn(`Î‘ÏƒÏ…Î¼Ï†Ï‰Î½Î¯Î± ÏƒÏ„Î¿ Ï€Î»Î®Î¸Î¿Ï‚ Ï„Ï‰Î½ ÎµÎ¾Î±Ï‡Î¸Î­Î½Ï„Ï‰Î½ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½. Î‘Î½Î±Î¼ÎµÎ½ÏŒÎ¼ÎµÎ½Î±: ${batch.originalIndices.length}, Î›Î®Ï†Î¸Î·ÎºÎ±Î½: ${extractedSegments.length}. Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÎµ Î±ÏÏ‡Î¹ÎºÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿.`);
                        translationErrorOccurred = true;

                        for (const originalIndex of batch.originalIndices) {
                            translatedBlocks[originalIndex] = {
                                id: srtBlocks[originalIndex].id,
                                timestamps: srtBlocks[originalIndex].timestamps,
                                text: srtBlocks[originalIndex].text + `
[Î‘Î´Ï…Î½Î±Î¼Î¯Î± Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·Ï‚ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚ - Î‘ÏƒÏ…Î¼Ï†Ï‰Î½Î¯Î± ÎµÎ¾Î±Î³Ï‰Î³Î®Ï‚]`
                            };
                        }
                    } else {
                        // Î‘Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ· Ï„Ï‰Î½ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½
                        for (let j = 0; j < batch.originalIndices.length; j++) {
                            const originalIndex = batch.originalIndices[j];
                            const translatedSegment = extractedSegments[j] || "";
                            translatedBlocks[originalIndex] = {
                                id: srtBlocks[originalIndex].id,
                                timestamps: srtBlocks[originalIndex].timestamps,
                                text: translatedSegment
                            };
                        }
                    }
                }
            } catch (apiError) {
                console.error(`Î£Ï†Î¬Î»Î¼Î± Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·Ï‚ Î¿Î¼Î±Î´Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Ï‰Î½ Î¼Ï€Î»Î¿Îº (Î¿Î¼Î¬Î´Î± ${batchIndex + 1}):`, apiError);
                translationErrorOccurred = true;

                for (const originalIndex of batch.originalIndices) {
                    translatedBlocks[originalIndex] = {
                        id: srtBlocks[originalIndex].id,
                        timestamps: srtBlocks[originalIndex].timestamps,
                        text: srtBlocks[originalIndex].text + `
[Î‘Î´Ï…Î½Î±Î¼Î¯Î± Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·Ï‚ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚ - Î£Ï†Î¬Î»Î¼Î± API]`
                    };
                }
                showMessage("error", `ÎŸÏÎ¹ÏƒÎ¼Î­Î½Î± Ï„Î¼Î®Î¼Î±Ï„Î± Î´ÎµÎ½ Î¼ÎµÏ„Î±Ï†ÏÎ¬ÏƒÏ„Î·ÎºÎ±Î½ Î»ÏŒÎ³Ï‰ ÏƒÏ†Î¬Î»Î¼Î±Ï„Î¿Ï‚. Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ ÎºÎ¿Î½ÏƒÏŒÎ»Î±.`);
            }
        }

        // Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ ÏŒÎ»Î± Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î± Î­Ï‡Î¿Ï…Î½ Î¼ÎµÏ„Î±Ï†ÏÎ±ÏƒÏ„ÎµÎ¯
        for (let i = 0; i < srtBlocks.length; i++) {
            if (translatedBlocks[i] === undefined || translatedBlocks[i] === null) {
                translatedBlocks[i] = {
                    id: srtBlocks[i].id,
                    timestamps: srtBlocks[i].timestamps,
                    text: srtBlocks[i].text + `
[Î‘Î´Ï…Î½Î±Î¼Î¯Î± Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·Ï‚ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚ - Î‘Ï€ÏÏŒÎ²Î»ÎµÏ€Ï„Î¿ Î£Ï†Î¬Î»Î¼Î±]`
                };
                translationErrorOccurred = true;
            }
        }

        const translatedSrtContent = reconstructSrt(translatedBlocks);
        const blob = new Blob([translatedSrtContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = selectedFile.name.replace('.srt', '.srt.ell');
        downloadLink.style.display = 'block';

        if (translationErrorOccurred) {
            showMessage("error", `Î— Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ, Î±Î»Î»Î¬ Ï…Ï€Î®ÏÎ¾Î±Î½ ÏƒÏ†Î¬Î»Î¼Î±Ï„Î± ÏƒÎµ Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î± Ï„Î¼Î®Î¼Î±Ï„Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ ÎºÎ¿Î½ÏƒÏŒÎ»Î±.`);
        } else {
            showMessage("success", `Î— Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚ Î³Î¹Î± ÏŒÎ»Î± Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î±!`);
        }

    } catch (error) {
        console.error("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·Ï‚:", error);
        showMessage("error", `Î‘Î´Ï…Î½Î±Î¼Î¯Î± Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚ Ï„Î·Ï‚ Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·Ï‚: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
        translateBtn.disabled = false;
    }
});