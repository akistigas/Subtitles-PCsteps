translateBtn.addEventListener('click', async () => {
    if (!selectedFile) {
        showMessage("error", "Παρακαλώ επιλέξτε ένα αρχείο .srt.");
        return;
    }
    loadingSpinner.classList.remove('hidden');
    translateBtn.disabled = true;
    messageBox.style.display = 'none';
    downloadLink.style.display = 'none';
    let translationErrorOccurred = false;

    try {
        const fileContent = await selectedFile.text();
        const srtBlocks = parseSrt(fileContent);
        if (srtBlocks.length === 0) {
            showMessage("info", "Το αρχείο SRT είναι κενό ή έχει λανθασμένη μορφή.");
            return;
        }

        const translatedBlocks = new Array(srtBlocks.length);
        let batches = [];
        let currentBatchTexts = [];
        let currentBatchOriginalIndices = [];

        // Create batches
        for (let i = 0; i < srtBlocks.length; i++) {
            const block = srtBlocks[i];
            const blockText = block.text;
            const potentialBatchSize = currentBatchTexts.join(DELIMITER).length + blockText.length + (currentBatchTexts.length > 0 ? DELIMITER.length : 0);

            if (potentialBatchSize > MAX_CHARS_PER_BATCH && currentBatchTexts.length > 0) {
                batches.push({
                    texts: currentBatchTexts,
                    originalIndices: currentBatchOriginalIndices
                });
                currentBatchTexts = [];
                currentBatchOriginalIndices = [];
            }
            currentBatchTexts.push(blockText);
            currentBatchOriginalIndices.push(i);

            if (i === srtBlocks.length - 1 && currentBatchTexts.length > 0) {
                batches.push({
                    texts: currentBatchTexts,
                    originalIndices: currentBatchOriginalIndices
                });
            }
        }

        // Process each batch
        for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
            const batch = batches[batchIndex];
            const batchPromptText = batch.texts.join(DELIMITER);

            const translationPrompt = `Μετάφρασε τα ακόλουθα τμήματα υποτίτλων από τα Αγγλικά στα Ελληνικά. Κάθε τμήμα οριοθετείται ΑΚΡΙΒΩΣ από το \`${DELIMITER}\`. Μετάφρασε μόνο το κείμενο μεταξύ των οριοθετητών, χωρίς να προσθέσεις καμία μορφοποίηση (όπως ετικέτες HTML), και διατήρησε τον ίδιο αριθμό οριοθετητών στην απάντησή σου. Μην τροποποιήσεις τους οριοθετητές ή τη σειρά των τμημάτων. Διατήνει το ακριβές νόημα και ύφος κάθε υποτίτλου. Εάν ένα τμήμα είναι κενό, επέστρεψε κενό τμήμα.
\`\`\`
${batchPromptText}
\`\`\`
`;

            const firstIndex = batch.originalIndices[0] + 1;
            const lastIndex = batch.originalIndices[batch.originalIndices.length - 1] + 1;
            showMessage("info", `Μεταφράζονται οι υπότιτλοι: ${firstIndex} - ${lastIndex} / ${srtBlocks.length} (ομαδοποιημένα, ομάδα ${batchIndex + 1} από ${batches.length})`);

            try {
                const batchedTranslatedText = await callGeminiAPI(translationPrompt);

                // 🔥 ΚΛΕΙΔΙΟΥ ΛΥΣΗ: Αντί για split(), χρησιμοποιούμε αναζήτηση διαχωριστικών
                const delimiterRegex = new RegExp(`(${DELIMITER})`, 'g');
                const matches = [...batchedTranslatedText.matchAll(delimiterRegex)];
                
                // Έλεγχος αν το πλήθος των διαχωριστικών αντιστοιχεί
                if (matches.length !== batch.originalIndices.length) {
                    console.warn(`Ασυμφωνία στο πλήθος των διαχωριστικών. Αναμενόμενα: ${batch.originalIndices.length}, Λήφθηκαν: ${matches.length}. Επαναφορά σε αρχικό κείμενο.`);
                    translationErrorOccurred = true;

                    for (const originalIndex of batch.originalIndices) {
                        translatedBlocks[originalIndex] = {
                            id: srtBlocks[originalIndex].id,
                            timestamps: srtBlocks[originalIndex].timestamps,
                            text: srtBlocks[originalIndex].text + `
[Αδυναμία μετάφρασης αυτού του τμήματος - Ασυμφωνία διαχωριστικών]`
                        };
                    }
                } else {
                    // Εξαγωγή των τμημάτων μεταξύ των διαχωριστικών
                    let start = 0;
                    const extractedSegments = [];

                    for (let i = 0; i < matches.length; i++) {
                        const match = matches[i];
                        const segmentStart = start;
                        const segmentEnd = match.index;

                        const segment = batchedTranslatedText.substring(segmentStart, segmentEnd).trim();
                        extractedSegments.push(stripHtmlTags(segment));

                        start = match.index + match[0].length; // Ξεκινάμε μετά το διαχωριστικό
                    }

                    // Προσθήκη του τελευταίου τμήματος (μετά το τελευταίο διαχωριστικό)
                    const finalSegment = batchedTranslatedText.substring(start).trim();
                    extractedSegments.push(stripHtmlTags(finalSegment));

                    // Έλεγχος αν το πλήθος των εξαχθέντων τμημάτων αντιστοιχεί
                    if (extractedSegments.length !== batch.originalIndices.length) {
                        console.warn(`Ασυμφωνία στο πλήθος των εξαχθέντων τμημάτων. Αναμενόμενα: ${batch.originalIndices.length}, Λήφθηκαν: ${extractedSegments.length}. Επαναφορά σε αρχικό κείμενο.`);
                        translationErrorOccurred = true;

                        for (const originalIndex of batch.originalIndices) {
                            translatedBlocks[originalIndex] = {
                                id: srtBlocks[originalIndex].id,
                                timestamps: srtBlocks[originalIndex].timestamps,
                                text: srtBlocks[originalIndex].text + `
[Αδυναμία μετάφρασης αυτού του τμήματος - Ασυμφωνία εξαγωγής]`
                            };
                        }
                    } else {
                        // Αντιστοίχιση των τμημάτων
                        for (let j = 0; j < batch.originalIndices.length; j++) {
                            const originalIndex = batch.originalIndices[j];
                            const translatedSegment = extractedSegments[j] || "";
                            translatedBlocks[originalIndex] = {
                                id: srtBlocks[originalIndex].id,
                                timestamps: srtBlocks[originalIndex].timestamps,
                                text: translatedSegment
                            };
                        }
                    }
                }
            } catch (apiError) {
                console.error(`Σφάλμα μετάφρασης ομαδοποιημένων μπλοκ (ομάδα ${batchIndex + 1}):`, apiError);
                translationErrorOccurred = true;

                for (const originalIndex of batch.originalIndices) {
                    translatedBlocks[originalIndex] = {
                        id: srtBlocks[originalIndex].id,
                        timestamps: srtBlocks[originalIndex].timestamps,
                        text: srtBlocks[originalIndex].text + `
[Αδυναμία μετάφρασης αυτού του τμήματος - Σφάλμα API]`
                    };
                }
                showMessage("error", `Ορισμένα τμήματα δεν μεταφράστηκαν λόγω σφάλματος. Παρακαλώ ελέγξτε την κονσόλα.`);
            }
        }

        // Βεβαιωθείτε ότι όλα τα τμήματα έχουν μεταφραστεί
        for (let i = 0; i < srtBlocks.length; i++) {
            if (translatedBlocks[i] === undefined || translatedBlocks[i] === null) {
                translatedBlocks[i] = {
                    id: srtBlocks[i].id,
                    timestamps: srtBlocks[i].timestamps,
                    text: srtBlocks[i].text + `
[Αδυναμία μετάφρασης αυτού του τμήματος - Απρόβλεπτο Σφάλμα]`
                };
                translationErrorOccurred = true;
            }
        }

        const translatedSrtContent = reconstructSrt(translatedBlocks);
        const blob = new Blob([translatedSrtContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = selectedFile.name.replace('.srt', '.srt.ell');
        downloadLink.style.display = 'block';

        if (translationErrorOccurred) {
            showMessage("error", `Η μετάφραση ολοκληρώθηκε, αλλά υπήρξαν σφάλματα σε ορισμένα τμήματα. Παρακαλώ ελέγξτε την κονσόλα.`);
        } else {
            showMessage("success", `Η μετάφραση ολοκληρώθηκε επιτυχώς για όλα τα τμήματα!`);
        }

    } catch (error) {
        console.error("Σφάλμα κατά τη διαδικασία μετάφρασης:", error);
        showMessage("error", `Αδυναμία ολοκλήρωσης της μετάφρασης: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
        translateBtn.disabled = false;
    }
});